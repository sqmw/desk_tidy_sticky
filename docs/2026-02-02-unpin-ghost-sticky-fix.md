# 取消钉住后贴纸在交互模式“复活”的修复

## 问题描述
- 取消钉住后，主界面与贴纸列表显示正确。
- 但切换到鼠标交互模式时，刚取消的贴纸在原位置再次出现。

## 根因分析
- 便笺独立窗口仍在运行，但因点击穿透/桌面层级而“看起来消失”。
- 该窗口在后续拖动/位置保存时调用 `updateNotePosition`，若内存中仍是旧的 `isPinned=true`，会把旧状态写回 `notes.json`，导致“复活”。
- 交互模式切换仅更新鼠标模式，没有强制重新读取便笺状态，未触发自动关闭。

## 解决方案
1. 位置持久化前强制刷新数据，避免用旧内存覆盖最新状态。
2. 在点击穿透切换时重新读取便笺状态，若已取消钉住则立即关闭窗口。

## 进一步修复（单写入者）
上面的方案属于“止血”（降低脏数据写回概率），但从根上讲只要 **多个进程都能直接写 `notes.json`**，就仍存在写写覆盖的可能。

因此新增了 Notes 的 **Single Writer 架构**：只有 panel 进程允许写入；其他进程通过 IPC 命令请求修改，避免任何非 panel 进程把旧缓存回写到磁盘。

详见：`docs/2026-02-02-single-writer-notes.md`

## 代码改动
- `lib/services/notes_service.dart`
  - `updateNotePosition` 先 `loadNotes()`，确保落盘前是最新状态。
- `lib/pages/note_window/note_window_page.dart`
  - `_handleClickThroughChanged` 改为调用 `_loadNote()`，让窗口在取消钉住后自动关闭。

## 手动验证
1. 钉住便笺 -> 取消钉住（主界面显示未钉住）。
2. 切换到鼠标交互模式，确认该贴纸不会再次出现。
3. 拖动其他贴纸后，确保 pin/unpin 状态不会被位置保存覆盖。

## 影响范围
- 仅影响便笺窗口的点击穿透切换与位置持久化。
- 不改变已有 pin/unpin 逻辑与 UI 交互。
