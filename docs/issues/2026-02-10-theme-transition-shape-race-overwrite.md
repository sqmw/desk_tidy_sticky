# 主题扩散形状重启后回退为默认值（并发写覆盖）

## 现象
- 用户将工作台主题扩散方式设置为 `爱心` 后，重启应用有概率变回 `圆形`。
- 偏好文件中有时能看到已写入 `heart`，但后续其他设置保存会再次覆盖回 `circle`。

## 根因
- 偏好更新逻辑采用「每次更新前重新读取 + 合并 + 全量写回」。
- 多个 `updatePreferences` 并发触发时，后触发者可能基于旧快照合并，导致把新字段回滚。
- 该问题本质是 **读改写竞态**（read-modify-write race）。

## 修复
- 文件：`src/lib/preferences/preferences-store.js`
- 调整：
  1. 引入 `prefsCache` 作为会话内最新快照。
  2. 引入 `writeQueue` 串行化所有偏好写入，保证同一时刻只有一个写任务。
  3. `getPreferences` 返回安全对象并刷新 `prefsCache`，避免空值导致类型与运行期不稳定。

## 影响范围
- 工作台主题扩散形状持久化稳定。
- 其他偏好字段（排序、语言、番茄配置等）也一起获得并发写安全性提升。

## 验证
- 执行：`npm run check`
- 结果：`0 errors, 0 warnings`

## 备注
- 当前是前端会话内串行；若未来存在多窗口同时频繁写偏好，可进一步考虑后端原子更新接口。
