# 桌面贴纸启动失败原因分析及并存机制说明 (2026-01-27)

## 1. 核心问题：贴纸无法启动的具体原因

在多进程模式下，贴纸无法正常显示并导致主程序异常，主要由以下三个技术细节引起：

### 1.1 分离进程状态错误 (Detached Process Exception)
- **原因**：由于贴纸需要作为背景进程独立运行，我们使用了 `ProcessStartMode.detachedWithStdio` 启动模式。
- **冲突点**：在 Dart 的 `dart:io` 库中，以 `detached` 模式启动的进程对象**不允许被监控退出码 (`exitCode`)**。
- **现象**：当代码尝试调用 `proc.exitCode.then(...)` 时，会直接抛出 `Bad state: Process is detached` 异常。这个异常发生在启动流程的中途，中断了后续所有初始化指令（如设置语言、点击穿透等），并导致管理类由于捕获到错误而强制关闭了刚启动的进程。

### 1.2 启动参数丢失 (Main Arguments Missing)
- **原因**：之前的 `main` 函数签名没有接受 `List<String> args`，且使用了不正确的初始化方式。
- **后果**：子进程启动后拿不到命令行中的 `--mode=overlay` 参数，默认回退到了“普通模式”。两个试图争夺“主窗口”控制权的进程会发生冲突，导致子进程闪退。

### 1.3 工作目录缺失 (Working Directory)
- **原因**：子进程未指定 `workingDirectory`。
- **后果**：在 Debug 或特定打包环境下，子进程可能无法正确找到相关的 DLL（如 Flutter 引擎库）或资源文件，导致冷启动失败。

---

## 2. 并存机制 (Coexistence Architecture)

根据用户要求，现在的设计允许**主窗口（便笺列表）**与**桌面贴纸**同时存在。

### 2.1 架构实现
- **进程隔离**：主面板和贴纸位于完全不同的系统进程中。
- **移除互斥逻辑**：删除了所有“开启贴纸隐藏主界面的逻辑”，以及“多进程失败后在主界面显示贴纸”的降级方案。
- **状态同步**：通过 `isRunningNotifier` 实时监听后台进程状态，仅通过托盘菜单的状态变化告知用户，不干扰窗口显示。

### 2.2 操作逻辑
- **开启贴纸**：在主界面点击“显示器”图标，贴纸在桌面背景显示，主界面不消失。
- **托盘交互**：
    - 点击托盘：仅展示/隐藏主界面。
    - 托盘菜单：包含专用的“开启/关闭贴纸”动态按钮。

## 3. 设计模式与原则
- **单一职责**：`OverlayProcessManager` 仅负责进程生命周期，不再干涉 UI 路由。
- **鲁棒性处理**：增加了 1.5 秒的启动观察期，并在无法捕获退出码的情况下采用基于通信的心跳/广播机制来管理状态。
